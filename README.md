
## Get started
Spin up postgres containers
```
make up
```

Get an example database
* https://www.postgresqltutorial.com/wp-content/uploads/2019/05/dvdrental.zip

Restore the database into the paglia database.
```
PGPASSWORD=pass pg_restore -h 127.0.0.1 -p 5555 -U postgres -d paglia dvdrental.tar
```

Create a schema only dump.
```
make dump_schema
```

Install liquibase
```
brew install liquibase
```

Generate the changelog
```
make generate
```

Check status for the new database.
```
make status
```

Update the newdb using the generated changelog.
```
make update
```

## Process to create a working changelog

### First error
Error:
```
Unexpected error running Liquibase: ERROR: type "year" does not exist
  Position: 146 [Failed SQL: (0) CREATE TABLE public.film (film_id INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL, title VARCHAR(255) NOT NULL, description TEXT, release_year YEAR(10), language_id SMALLINT NOT NULL, rental_duration SMALLINT DEFAULT 3 NOT NULL, rental_rate numeric(4, 2) DEFAULT 4.99 NOT NULL, length SMALLINT, replacement_cost numeric(5, 2) DEFAULT 19.99 NOT NULL, rating MPAA_RATING DEFAULT 'G', last_update TIMESTAMP WITHOUT TIME ZONE DEFAULT NOW() NOT NULL, special_features TEXT[], fulltext TSVECTOR NOT NULL, CONSTRAINT film_pkey PRIMARY KEY (film_id))]
```

Missing SQL
```
CREATE DOMAIN public.year AS integer CONSTRAINT year_check CHECK (((VALUE >= 1901) AND (VALUE <= 2155)));
```

Missing changelog xml
```
    <changeSet author="manual" id="1642327687659-32.1">
        <sqlFile dbms="all" encoding="utf8" endDelimiter=";" path="domain-year.sql" relativeToChangelogFile="true" splitStatements="true" stripComments="true"/>
    </changeSet>
```

Must also change `YEAR(10)` to `YEAR`.

### Second error

Error:
```
[2022-01-16 12:03:20] SEVERE [liquibase.integration] ERROR: type "mpaa_rating" does not exist
  Position: 356 [Failed SQL: (0) CREATE TABLE public.film (film_id INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL, title VARCHAR(255) NOT NULL, description TEXT, release_year YEAR, language_id SMALLINT NOT NULL, rental_duration SMALLINT DEFAULT 3 NOT NULL, rental_rate numeric(4, 2) DEFAULT 4.99 NOT NULL, length SMALLINT, replacement_cost numeric(5, 2) DEFAULT 19.99 NOT NULL, rating MPAA_RATING DEFAULT 'G', last_update TIMESTAMP WITHOUT TIME ZONE DEFAULT NOW() NOT NULL, special_features TEXT[], fulltext TSVECTOR NOT NULL, CONSTRAINT film_pkey PRIMARY KEY (film_id))]
liquibase.exception.CommandExecutionException: liquibase.exception.LiquibaseException: Unexpected error running Liquibase: Migration failed for change set changelog.xml::1642327687659-33::mikalsande (generated):
     Reason: liquibase.exception.DatabaseException: ERROR: type "mpaa_rating" does not exist
  Position: 356 [Failed SQL: (0) CREATE TABLE public.film (film_id INTEGER GENERATED BY DEFAULT AS IDENTITY NOT NULL, title VARCHAR(255) NOT NULL, description TEXT, release_year YEAR, language_id SMALLINT NOT NULL, rental_duration SMALLINT DEFAULT 3 NOT NULL, rental_rate numeric(4, 2) DEFAULT 4.99 NOT NULL, length SMALLINT, replacement_cost numeric(5, 2) DEFAULT 19.99 NOT NULL, rating MPAA_RATING DEFAULT 'G', last_update TIMESTAMP WITHOUT TIME ZONE DEFAULT NOW() NOT NULL, special_features TEXT[], fulltext TSVECTOR NOT NULL, CONSTRAINT film_pkey PRIMARY KEY (film_id))]
        at liquibase.command.CommandScope.execute(CommandScope.java:163)
        at liquibase.integration.commandline.CommandRunner.call(CommandRunner.java:45)
        at liquibase.integration.commandline.CommandRunner.call(CommandRunner.java:15)
        at picocli.CommandLine.executeUserObject(CommandLine.java:1953)
        at picocli.CommandLine.access$1300(CommandLine.java:145)
        at picocli.CommandLine$RunLast.executeUserObjectOfLastSubcommandWithSameParent(CommandLine.java:2352)
        at picocli.CommandLine$RunLast.handle(CommandLine.java:2346)
        at picocli.CommandLine$RunLast.handle(CommandLine.java:2311)
        at picocli.CommandLine$AbstractParseResultHandler.execute(CommandLine.java:2179)
        at picocli.CommandLine.execute(CommandLine.java:2078)
        at liquibase.integration.commandline.LiquibaseCommandLine.lambda$execute$1(LiquibaseCommandLine.java:325)
        at liquibase.Scope.child(Scope.java:189)
        at liquibase.Scope.child(Scope.java:165)
        at liquibase.integration.commandline.LiquibaseCommandLine.execute(LiquibaseCommandLine.java:291)
        at liquibase.integration.commandline.LiquibaseCommandLine.main(LiquibaseCommandLine.java:80)
Caused by: liquibase.exception.LiquibaseException: Unexpected error running Liquibase: Migration failed for change set changelog.xml::1642327687659-33::mikalsande (generated):
```

Missing SQL:
```
CREATE TYPE public.mpaa_rating AS ENUM (
    'G',
    'PG',
    'PG-13',
    'R',
    'NC-17'
);
```

Missing XML:
```
    <changeSet author="manual" id="1642327687659-32.2">
        <sqlFile dbms="all" encoding="utf8" endDelimiter=";" path="domain-mpaa_rating.sql" relativeToChangelogFile="true" splitStatements="true" stripComments="true"/>
    </changeSet>
```


### Third error

Error:
```
[2022-01-16 12:06:37] SEVERE [liquibase.integration] ERROR: function group_concat(text) does not exist
  Hint: No function matches the given name and argument types. You might need to add explicit type casts.
  Position: 199 [Failed SQL: (0) CREATE VIEW public.film_list AS SELECT film.film_id AS fid,
    film.title,
    film.description,
    category.name AS category,
    film.rental_rate AS price,
    film.length,
    film.rating,
    group_concat((((actor.first_name)::text || ' '::text) || (actor.last_name)::text)) AS actors
   FROM ((((category
     LEFT JOIN film_category ON ((category.category_id = film_category.category_id)))
     LEFT JOIN film ON ((film_category.film_id = film.film_id)))
     JOIN film_actor ON ((film.film_id = film_actor.film_id)))
     JOIN actor ON ((film_actor.actor_id = actor.actor_id)))
  GROUP BY film.film_id, film.title, film.description, category.name, film.rental_rate, film.length, film.rating;]
liquibase.exception.CommandExecutionException: liquibase.exception.LiquibaseException: Unexpected error running Liquibase: Migration failed for change set changelog.xml::1642327687659-34::mikalsande (generated):
     Reason: liquibase.exception.DatabaseException: ERROR: function group_concat(text) does not exist
  Hint: No function matches the given name and argument types. You might need to add explicit type casts.
  Position: 199 [Failed SQL: (0) CREATE VIEW public.film_list AS SELECT film.film_id AS fid,
    film.title,
    film.description,
    category.name AS category,
    film.rental_rate AS price,
    film.length,
    film.rating,
    group_concat((((actor.first_name)::text || ' '::text) || (actor.last_name)::text)) AS actors
   FROM ((((category
     LEFT JOIN film_category ON ((category.category_id = film_category.category_id)))
     LEFT JOIN film ON ((film_category.film_id = film.film_id)))
     JOIN film_actor ON ((film.film_id = film_actor.film_id)))
     JOIN actor ON ((film_actor.actor_id = actor.actor_id)))
  GROUP BY film.film_id, film.title, film.description, category.name, film.rental_rate, film.length, film.rating;]
        at liquibase.command.CommandScope.execute(CommandScope.java:163)
        at liquibase.integration.commandline.CommandRunner.call(CommandRunner.java:45)
        at liquibase.integration.commandline.CommandRunner.call(CommandRunner.java:15)
        at picocli.CommandLine.executeUserObject(CommandLine.java:1953)
        at picocli.CommandLine.access$1300(CommandLine.java:145)
        at picocli.CommandLine$RunLast.executeUserObjectOfLastSubcommandWithSameParent(CommandLine.java:2352)
        at picocli.CommandLine$RunLast.handle(CommandLine.java:2346)
        at picocli.CommandLine$RunLast.handle(CommandLine.java:2311)
        at picocli.CommandLine$AbstractParseResultHandler.execute(CommandLine.java:2179)
        at picocli.CommandLine.execute(CommandLine.java:2078)
        at liquibase.integration.commandline.LiquibaseCommandLine.lambda$execute$1(LiquibaseCommandLine.java:325)
        at liquibase.Scope.child(Scope.java:189)
        at liquibase.Scope.child(Scope.java:165)
        at liquibase.integration.commandline.LiquibaseCommandLine.execute(LiquibaseCommandLine.java:291)
        at liquibase.integration.commandline.LiquibaseCommandLine.main(LiquibaseCommandLine.java:80)
```

Missing SQL
```
CREATE FUNCTION public._group_concat(text, text) RETURNS text
    LANGUAGE sql IMMUTABLE
    AS $_$
SELECT CASE
  WHEN $2 IS NULL THEN $1
  WHEN $1 IS NULL THEN $2
  ELSE $1 || ', ' || $2
END
$_$;
```

Missing XML
```
    <changeSet author="manual" id="1642327687659-33.1">
        <sqlFile dbms="all" encoding="utf8" endDelimiter=";" path="function-group_concat.sql" relativeToChangelogFile="true" splitStatements="true" stripComments="true"/>
    </changeSet>
```